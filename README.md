# 四技二專甄選入學志願調查系統 (Google Apps Script)

## 專案總覽

本專案是一個基於 Google Apps Script 建構的網頁應用程式，旨在協助學校管理四技二專甄選入學的學生志願調查作業。系統允許學生線上填報志願，導師可查詢班級學生的填報狀況，管理員則可透過 Google Sheets 後台進行相關設定與資料管理。

## 主要功能

*   **學生端：**
    *   使用學校 Email 帳號登入。
    *   查看系統公告與個人基本資料。
    *   填寫/修改是否參加集體報名。
    *   根據報考群(類)別，選擇至多六個校系志願。
    *   提交志願後，可查看已填報的結果。
*   **導師端：**
    *   使用學校 Email 帳號登入。
    *   查詢導師班學生的志願填報狀況。
    *   查看班級填報統計資訊。
*   **管理端 (Google Sheets)：**
    *   設定系統參數（如系統名稱、關閉時間）。
    *   加入統測報名資料、校系科(組)學程資料、可報名之系科組學程數、導師名單
    *   匯出報名用 CSV 檔
    *   查看學生填寫日誌。
    *   清除快取

## 系統架構

本系統完全建構於 Google Apps Script 之上，並利用 Google Sheets 作為資料庫。

*   **前端：** 使用 HTML、CSS 和 JavaScript (透過 `HtmlService`) 產生使用者介面。
    *   `index.html`: 學生填報介面。
    *   `teacherView.html`: 導師查詢介面。
    *   `success.html`: 學生提交成功頁面。
*   **後端：** Google Apps Script (`.gs` 檔案) 處理業務邏輯、資料存取和使用者驗證。
    *   `main.js`: 處理主要的 HTTP GET/POST 請求、頁面渲染、選單建立。
    *   `retrieveData.js`: 負責從 Google Sheets 取得設定、使用者資料、志願選項等。
    *   `utilities.js`: 提供共用工具函式，如資料驗證、在試算表中尋找資料、更新資料列、CSV 匯出等。
    *   `teacher.js`: 處理導師相關功能，如取得班級學生志願資料。
    *   `cache.js`: (推測) 處理快取邏輯，以提升效能。
*   **資料庫：** Google Sheets。

## Google Sheets 結構

專案依賴以下 Google Sheets 工作表：

1.  **參數設定 (configSheet):**
    *   用途：儲存系統全域設定。
    *   欄位範例：`系統名稱`, `系統關閉時間`, `報名學校代碼`, `說明1`, `說明2`...
2.  **統測報名資料 (examDataSheet):**
    *   用途：儲存學生基本報名資料。
    *   欄位範例：`信箱`, `統一入學測驗報名序號`, `班級名稱`, `考生姓名`, `報考群(類)代碼`, `報考群(類)名稱`...
3.  **志願選項 (choicesSheet):**
    *   用途：儲存各群(類)別可選填的校系科組學程代碼與名稱。
    *   欄位範例：`群(類)代碼`, `群(類)名稱`, `校系科組學程代碼`, `校系科組學程名稱`, `招生名額`... (實際欄位需依 `getOptionData` 函式邏輯為準)
4.  **可報名之系科組學程數 (limitOfSchoolsSheet):**
    *   用途：定義各校可報名的系科組學程數量上限。
    *   欄位範例：`學校代碼`, `學校名稱`, `可報名系科組學程數上限`。
5.  **導師名單 (teacherSheet):**
    *   用途：儲存導師基本資料，用於權限判斷。
    *   欄位範例：`信箱`, `班級`, `姓名`...
6.  **考生志願列表 (studentChoiceSheet):**
    *   用途：儲存學生填報的志願結果。
    *   欄位範例：`信箱`, `是否參加集體報名`, `志願1校系代碼`, `志願2校系代碼`... `志願6校系代碼` (以及其他學生基本資料欄位，用於日誌或顯示)。
7.  **匯入報名系統 (forImportSheet):**
    *   用途：產生特定格式的資料，供匯出至其他報名系統使用。
8.  **日誌 (logSheet):**
    *   用途：記錄學生每次提交志願的動作。
    *   欄位範例：`時間戳記`, `信箱`, `班級名稱`, `學號`, `考生姓名`, `統一入學測驗報名序號`, `報考群(類)名稱`, `是否參加`, `志願1名稱`, `志願2名稱`... `志願6名稱`。

## 設定與部署

1.  **建立 Google Sheet：**
    *   建立一個新的 Google Sheet。
    *   依照上述「Google Sheets 結構」建立對應的工作表，並填入表頭。
    *   （重要）確保各工作表名稱與程式碼中 `ss.getSheetByName("工作表名稱")` 的參數一致。
2.  **開啟 Apps Script 編輯器：**
    *   在 Google Sheet 中，點選「擴充功能」 > 「Apps Script」。
3.  **複製程式碼：**
    *   將本專案中的所有 `.js` 和 `.html` 檔案的內容，分別複製到 Apps Script 編輯器中對應的檔案，請將 `.js` 檔案的內容複製到對應的 `.gs` 檔案中。
    *   `appsscript.json` 檔案定義了專案的執行環境和權限，請確保其內容正確。
4.  **設定專案屬性 (如有需要)：**
    *   某些設定可能儲存在專案屬性中，需依實際情況設定。
5.  **初次執行與授權：**
    *   在 Apps Script 編輯器中，選擇任一主要函式（如 `onOpen` 或 `doGet`）並執行。
    *   系統會要求授權，請依照指示完成授權步驟，允許指令碼存取您的 Google 帳戶資料 (試算表、使用者資訊等)。
6.  **部署為網頁應用程式：**
    *   在 Apps Script 編輯器中，點選右上角的「部署」 > 「新增部署作業」。
    *   選擇類型為「網頁應用程式」。
    *   在「設定」中：
        *   **說明：** (選填) 輸入部署說明。
        *   **執行應用程式的身分：** 選擇「我」。
        *   **誰可以存取：** 選擇「知道連結的任何人」(或根據學校需求選擇更嚴格的選項，但通常需搭配 Google Workspace 環境設定)。
    *   點選「部署」。
    *   複製產生的「網頁應用程式網址」，此網址即為學生和導師存取系統的入口。
7.  **`onOpen` 觸發器：**
    *   `onOpen` 函式會在試算表開啟時自動執行，建立自訂選單。通常不需要手動設定觸發器，Apps Script 會自動處理。

## 使用說明

### 學生
1.  開啟管理員提供的網頁應用程式網址。
2.  使用學校提供的 Email 帳號登入。
3.  依照頁面指示填寫志願資料。
4.  提交後，可看到成功訊息及已填報的志願。

### 導師
1.  開啟管理員提供的網頁應用程式網址。
2.  使用學校提供的 Email 帳號登入。
3.  系統會自動判斷導師身分並顯示導師介面。
4.  可查詢班級學生的填報狀況。

### 管理員 (透過 Google Sheet)
*   **資料維護：** 直接在對應的 Google Sheets 工作表中新增、修改或刪除資料。
*   **系統設定：** 修改「參數設定」工作表中的值。
*   **執行管理功能：**
    *   開啟 Google Sheet。
    *   點選「志願調查系統」自訂選單。
    *   選擇「匯出報名用CSV」或「清除快取」。

## 安全性考量

本專案已實作一些基本的安全性措施：

*   **X-Frame-Options:** 設定為 `SAMEORIGIN` 防止點擊劫持。
*   **輸入驗證：** 對使用者輸入（如志願代碼、請求參數）進行格式和長度驗證。
*   **HTML 清理：** 對從試算表讀取的內容或錯誤訊息進行 HTML 特殊字元轉義，以防止 XSS 攻擊。
*   **參數限制：** 限制 `doGet` 允許的參數名稱。
*   **錯誤處理：** 包含 try-catch 區塊來處理預期外的錯誤，並記錄日誌。
*   **快取使用：** 適當使用快取以提升效能，同時也提供清除快取功能。

## 注意事項與限制

*   **Google Apps Script 配額：** Google Apps Script 有每日執行時間、API 呼叫次數等配額限制。在高流量情況下可能需要注意。
*   **錯誤日誌：** 錯誤和執行日誌會記錄在 Apps Script 儀表板的「執行作業」中，以及部分自訂日誌記錄在「日誌」工作表。
*   **相依性：** 本專案強烈依賴 Google Sheets 的結構和命名，修改時需同步更新程式碼。
*   **單一指令碼執行緒：** Apps Script 為單執行緒執行，複雜或長時間的計算可能影響使用者體驗。

## 未來可能的改進方向

*   在學生送出志願後，寄送該次填報結果的通知信。
